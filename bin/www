#!/usr/bin/env node
var debug = require('debug')('apiary');
var app = require('../app');
var scgi = require("scgi-stream");
var RPC  = require("xmlrpc-stream");

var rpc = new RPC(function() {
    return scgi.duplex({
        host: "127.0.0.1",
        port: 4000,
        path: "/"
    });
});

app.set('port', process.env.PORT || 3000);

var server = app.listen(app.get('port'), function() {
    debug('Express server listening on port ' + server.address().port);
});


var io = require('socket.io')(server);

io.on('connection', function (socket) {
    socket.on('rtorrent', function(payload) {
        rpc.call(payload, function(err, res) {
            if (err) {
                console.log(err);
            } else {
                console.log(payload, ':', res);
                socket.emit('rtorrent', payload + ': ' + res);
            }
        })
    })
});